// Enable Singularity support
singularity {
    enabled = true
    autoMounts = true
    pullTimeout = '60m'
    cacheDir = '/net/bmc-lab3/data/bcc/charliew/.singularity_cache'
}

// Enable conda for other processes
conda {
    enabled = true
    useMamba = true
    cacheDir = '/net/bmc-lab3/data/bcc/charliew/.conda/pkgs'
}

// Process configuration
process {
    withName: 'CHOPPER' {
        container = 'bumproo/nanoplotchopper'
        cpus = 4
        memory = '8 GB'
    }
    withName: 'DOWNSAMPLE_FASTQ' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '4 GB'
    }
    withName: 'FLYE_PREFLIGHT' {
        container = 'bumproo/flye:2.9.6'
        cpus = 4
        memory = '8 GB'
    }
    withName: 'PARSE_PREFLIGHT_RESULTS' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '2 GB'
    }
    withName: 'NANOPLOT' {
        container = 'bumproo/nanoplotchopper'
        cpus = 2
        memory = '4 GB'
    }
    withName: 'NANOPLOT_ORIGINAL' {
        container = 'bumproo/nanoplotchopper'
        cpus = 2
        memory = '4 GB'
    }
    withName: 'PARSE_NANOSTATS' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '2 GB'
    }
    withName: 'FILTER_ASSEMBLY_CANDIDATES' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '2 GB'
    }
    withName: 'FLYE' {
        container = 'bumproo/flye:2.9.6'
        cpus = 8
        memory = '32 GB'
        time = '24h'
    }
    withName: 'TRANSGENE_BLAST' {
        container = 'ncbi/blast:latest'
        cpus = 2
        memory = '4 GB'
        time = '2h'
    }
    withName: 'PARSE_TRANSGENE_BLAST' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '2 GB'
        time = '30m'
    }
    withName: 'GATHER_ASSEMBLY_STATS' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '2 GB'
        time = '30m'
    }
    withName: 'SIMPLE_RESULTS_SUMMARY' {
        container = 'bumproo/python:3.11'
        cpus = 1
        memory = '2 GB'
        time = '30m'
    }
    // Assembly Evaluation Module Processes (Complete Pipeline)
    withName: 'ALIGN_ASSEMBLY_TO_GENOME' {
        container = 'bumproo/general_genomics:latest'
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }
    withName: 'REPAIR_ASSEMBLY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 1
        memory = '8 GB'
        time = '1h'
    }
    withName: 'ALIGN_ANNOTATED_ASSEMBLY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }
    withName: 'CALCULATE_CHROMOSOME_COVERAGE' {
        container = 'bumproo/general_genomics:latest'
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }
    withName: 'CONSOLIDATE_COVERAGE_SUMMARY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 1
        memory = '2 GB'
        time = '30m'
    }
    withName: 'FINALIZE_ASSEMBLY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 1
        memory = '8 GB'
        time = '1h'
    }
    withName: 'ALIGN_FINAL_ASSEMBLY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }
    withName: 'MAP_READS_TO_ASSEMBLY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 8
        memory = '32 GB'
        time = '4h'
    }
    withName: 'BLAST_TRANSGENE_TO_ASSEMBLY' {
        container = 'ncbi/blast:latest'
        cpus = 2
        memory = '8 GB'
        time = '1h'
    }
    withName: 'CONVERT_BLAST_TO_BED' {
        container = 'bumproo/general_genomics:latest'
        cpus = 1
        memory = '2 GB'
        time = '30m'
    }
    withName: 'MAP_TRANSCRIPTS_TO_ASSEMBLY' {
        container = 'bumproo/general_genomics:latest'
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }
}

// Parameters
params {
    input_fastq = null
    name = null
    samples = null
    outdir = "results"
    genome_size = "10m"
    
    // Size filtering parameters
    min_quality = 10
    size_ranges = [
        [min: 40000, max: null,  name: "40k_Plus"],
        [min: 50000, max: null,  name: "50k_Plus"]
    ]
    
    // Downsampling parameters
    downsample_rates = [0.25, 0.5, 0.75]
    
    // Bootstrap parameters
    replicates = 1        // Default number of replicates
    
    // Transgene library configuration
    transgene_library = "${projectDir}/transgenes/transgene_library.csv"
    transgene_dir = "${projectDir}/transgenes"
    default_transgene = "A-vector_herceptin_pEY345"
    transgene = null
    
    // Assembly evaluation parameters
    run_assembly_evaluation = false  // Set to true to run assembly evaluation
    reference_genome = null  // Path to WT reference genome (e.g., WT_mito.fa)
    reference_chromosomes = null  // Optional: Path to chromosome-only reference for coverage calculation
    transcripts_fasta = null  // Optional: Path to transcripts file for mapping
    min_assembly_depth = 20  // Minimum depth for assembly evaluation
    max_assembly_depth = 100  // Maximum depth for assembly evaluation
}

// Execution reports
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']
